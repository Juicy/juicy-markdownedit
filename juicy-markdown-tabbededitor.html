<!--
Copyright 2014 Smörgåsbord Development. All rights reserved.
version: 0.0.2
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../juicy-markdown/juicy-markdown.html"> 
<link rel="import" href="../juicy-markdown-editor/juicy-markdown-editor.html">
<script src="../to-markdown/dist/to-markdown.js"></script>
<dom-module id="juicy-markdown-tabbededitor">
    <style>

        :host {

            display: flex;

            flex-direction: column;

            align-items:stretch;

            font-size: inherit;
        }

        #tabHeader {

            flex:  0 1 auto;

            background-color: #f7f7f7;
            border-color: #dddddd;

            border-style:solid;
            border-top-width: 0px;
            border-left-width: 0px;
            border-right-width: 0px;
            border-bottom-width: 1px;

            font-size: inherit;
        }

        #tabPageContent {

            display: flex;

            flex: 1 0;
        }

        juicy-markdown-editor {

            flex: 1 0;
        }

        juicy-markdown {

            flex: 1;
                            
            padding: 10px;
        }
        
        #preview-div {

            flex: 1;
                            
            padding: 10px;
        }

        #tabFooter {

            flex: 0 1 auto;

            background-color: #f7f7f7;
            border-color: #dddddd;
            border-style:solid;
            border-top-width: 1px;
            border-left-width: 0px;
            border-right-width: 0px;
            border-bottom-width: 0px;
        }

        #tabPageContent > div,
        #tabPageContent ::slotted(*) {

            flex: 1;

            display: flex;

            flex-direction: row;
            height: 400px;
        }

        #tabPageContent > [hidden],
        #tabPageContent ::slotted([hidden]) {
            display: none;
        }

        #tabHeader button,
        #tabHeader ::slotted(*) {

            border-top-width: 1px;
            border-left-width: 1px;
            border-right-width: 1px;
            border-bottom-width: 0px;
            border-style:solid;
            border-color: transparent;

            margin-left: 5px;
            margin-right: 5px;
            margin-top: 5px;
            margin-bottom: -1px;

            padding: 5px 10px 5px 10px;
            background-color: transparent;
            color:#666666;
            text-decoration:none;
            outline: none;
            cursor:pointer;

            font-size: inherit;
        }

        #tabHeader button:focus,
        #tabHeader ::slotted(:focus) {

            outline: none; 
        }

        #tabHeader button:active,
        #tabHeader ::slotted(:active) {

            outline: none;
        }

        #tabHeader button.selected,
        #tabHeader ::slotted(.selected) {

            border-color: #dddddd;
            border-style:solid;
            border-top-width: 1px;
            border-left-width: 1px;
            border-right-width: 1px;
            border-bottom-width: 1px;
            border-bottom-color:white;
            color: black;
            background-color: white;

            border-top-left-radius:4px;
            border-top-right-radius:4px;
        }

    </style>
    <template>
        <div id="tabHeader" on-click="buttonClick">
            <slot name="tab-button"></slot>
            <button id="markdownButton">Markdown</button>
            <button>Preview</button>
        </div>

        <div id="tabPageContent">
            <slot name="tab-body"></slot>
            
            <div>
                <juicy-markdown-editor customheader="{{customheader}}" ghcss="{{ghcss}}" uploadurl="{{uploadurl}}" placeholder="{{placeholder}}" id="mdedit" value="{{markdownValue}}" on-change="markdownValueChanged"></juicy-markdown-editor>
            </div>

            <div>
                <div id="preview-div" inner-h-t-m-l="{{htmlValue}}"></div>
            </div>
        </div>

        <div id="tabFooter"></div>
    </template>
</dom-module>
<script>
    "use strict";
    Polymer({
        is: 'juicy-markdown-tabbededitor',
        properties: {
            footer: {
                type: String,
                value: "",
                notify: true,
                observer: 'footerChanged'
            },
            htmlValue :{
                type: String,
                notify:true,
                value:"",
                observer: "htmlValueChanged"
            },
            markdownValue :{
                type: String,
                notify:true,
                value:"",
                observer: "markdownValueChanged"
            },
            placeholder: {
                type: String,
                value: ""
            },
            uploadurl: {
                type: String,
                value: ""
            },
            ghcss: {
                type: Boolean,
                value: false
            },
            customheader: {
                type: String,
                value: "x-file"
            }
        },
        attached: function() {
            this.$.mdedit.$.previewPanel.style.display = "none";
            var defaultButton = this.querySelectorAll("[slot='tab-button']")[0];
            if (!defaultButton) {
                defaultButton = this.$.markdownButton;
            }
            this.showPage(defaultButton);
        },
        showPage: function(button) {
            var domButtons = Array.from(this.querySelectorAll("[slot='tab-button']"));
            var domBodies = Array.from(this.querySelectorAll("[slot='tab-body']"));
            var shadowDomButtons = Array.from(this.$.tabHeader.children);
            var shadowDomBodies = Array.from(this.$.tabPageContent.children);

            var tab, index;
            var parent = button.parentNode;
            if (parent == this) {
                index = domButtons.indexOf(button);
                tab = domBodies[index];
            }
            else {
                index = shadowDomButtons.indexOf(button);
                tab = shadowDomBodies[index];
            }

            domButtons.forEach((elem) => elem.classList.remove('selected'));
            shadowDomButtons.forEach((elem) => elem.classList.remove('selected'));
            button.classList.add('selected');

            domBodies.forEach((elem) => elem.setAttribute('hidden', ''));
            shadowDomBodies.forEach((elem) => elem.setAttribute('hidden', ''));
            tab.removeAttribute('hidden');
        },
        htmlValueChanged: function(newValue, oldValue) {
            if (newValue !== null) {
                this.skipHtmlChange = true;
                this.markdownValue = toMarkdown(newValue, { converters: [{ filter: ['em', 'i'], replacement: (c) => ('*'+c+'*') }] });
            }
        },
        markdownValueChanged: function(newValue, oldValue) {
            if (!this.skipHtmlChange) {
                this.htmlValue = this.$.mdedit.$.previewPanel.$.preview.innerHTML;
            }
            this.skipHtmlChange = false;
        },
        footerChanged: function( newValue, oldValue) {
            this.$.tabFooter.innerHTML = newValue;
        },
        buttonClick: function(event, detail, sender) {
            if (event.target.nodeName == "BUTTON") {
                this.showPage(event.target);
            }
        },
        onFileUploadError: function(e) {

            e.stopPropagation();
            var xFile = e.detail;
            this.$.tabFooter.innerHTML = xFile.statusText;
        }
    });
</script>